<!DOCTYPE html >
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <title>From Info Windows to a Database: Saving User-Added Form Data</title>
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

    #map {
      height: 100%;
    }
    /* Optional: Makes the sample page fill the window. */

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.js"></script>
</head>

<body>
  <div id="map" height="460px" width="100%"></div>
  <div id="infoBOX">
    <table>
      <tr>
        <td>
          <form method="POST" action="/maps/map_id/locations">
        </td>
      </tr>
      <tr>
        <td>
          <input name="locationTitle" placeholder="Title" type="text">
        </td>
      </tr>
      <tr>
        <td>
          <textarea name="locationDesc" placeholder="Description Textarea"></textarea>
        </td>
      </tr>
      <tr>
        <td>
          <input name="locationImage" placeholder="Image URL" type="text">
        </td>
      </tr>
      <tr>
        <td>
          <button >Save</button>
        </td>
      </tr>
      </form>
    </table>
    <!-- <table>
      <tr>
        <td>Title:</td>
        <td><input type='text' id='title' /> </td>
      </tr>
      <tr>
        <td>Description:</td>
        <td><textarea id="description" placeholder="Description Textarea"></textarea> </td>
      </tr>
      <tr>
        <td>Image Url:</td>
        <td><input type='text' id='imageURL' />  </td>
      </tr>
      <tr>
        <td></td>
        <td><input type='button' value='Save' onclick='saveData()' /></td>
      </tr>
    </table> -->
  </div>
  <div id="message">Location saved</div>
  <script>
    var map;
    var marker;
    var infowindow;
    var messagewindow;

    function initMap() {
      var california = {
        lat: 37.4419,
        lng: -122.1419
      };
      map = new google.maps.Map(document.getElementById('map'), {
        center: california,
        zoom: 13
      });

      infowindow = new google.maps.InfoWindow({
        content: document.getElementById('infoBOX')
      })

      messagewindow = new google.maps.InfoWindow({
        content: document.getElementById('message')
      });

      google.maps.event.addListener(map, 'click', function(event) {
        marker = new google.maps.Marker({
          position: event.latLng,
          map: map
        });


        google.maps.event.addListener(marker, 'click', function() {
          infowindow.open(map, marker);
        });
      });
    }

    function saveData() {
      const title = escape(document.getElementById('title').value);
      const description = escape(document.getElementById('description').value);
      const imageURL = document.getElementById('imageURL').value;
      const latlng = marker.getPosition();


      console.log('DATA', title, description, imageURL, latlng.lat(), latlng.lng());

      req.body.lat = latlng.lat();
      req.body.lng = latlng.lng();

      // var url = 'phpsqlinfo_addrow.php?name=' + name + '&address=' + address +
      //   '&type=' + type + '&lat=' + latlng.lat() + '&lng=' + latlng.lng();
      //
      // $.ajax({
      //   method: 'POST',
      //   url: 'http://localhost:8080/maps/map_id/locations',
      //   data: $('#form').serialize()
      // }).then((data) => {
      //   console.log("DATA", data);
      // });



      // downloadUrl(url, function(data, responseCode) {
      //
      //   if (responseCode == 200 && data.length <= 1) {
      //     infowindow.close();
      //     messagewindow.open(map, marker);
      //   }
      // });
    }




    function downloadUrl(url, callback) {
      var request = window.ActiveXObject ?
        new ActiveXObject('Microsoft.XMLHTTP') :
        new XMLHttpRequest;

      request.onreadystatechange = function() {
        if (request.readyState == 4) {
          request.onreadystatechange = doNothing;
          callback(request.responseText, request.status);
        }
      };

      request.open('GET', url, true);
      request.send(null);
    }

    function doNothing() {}
  </script>
  <% include ./partials/_gmaps_api.ejs %>
  </script>

</body>

</html>
